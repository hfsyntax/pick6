import {
  getSeasons,
  getWeekResults,
  getConfigValue,
} from "../../actions/serverRequests"
import SeasonWeeksHandler from "../../components/SeasonWeeksHandler"

export const metadata = {
  title: "Pick6 - Results",
  description: "Generated by create next app",
}

export default async function results(props: {
  searchParams?: Promise<{
    season?: string
  }>
}) {
  const searchParams = await props.searchParams
  const currentSeason = Number(await getConfigValue("CURRENT_SEASON"))
  const selectedSeason = Number(
    searchParams.season ?? (await getConfigValue("CURRENT_SEASON")),
  )
  const currentWeek = Number(await getConfigValue("CURRENT_WEEK"))
  const results = await getWeekResults(
    selectedSeason,
    currentSeason,
    currentWeek,
  )
  const seasons = await getSeasons()
  const seasonID = seasons.find(
    (season) => season.season_number == selectedSeason,
  )?.season_id
  const columnWidths = {
    week_number: { small: 40, medium: 70, large: 100 },
    winner_names: { small: 100, medium: 200, large: 200 },
    loser_names: { small: 100, medium: 200, large: 200 },
  }

  const rowHeights = [
    35,
    ...results.map((week) => {
      const maxPlayers = Math.max(
        week["winners_count"],
        week["losers_count"],
        1,
      )
      // 35px row height + gap of 10px between each row
      return maxPlayers * 35 + (maxPlayers - 1) * 10
    }),
  ]

  return (
    <div className="absolute left-[50px] top-0 flex min-h-full w-[calc(100%-50px)] flex-col items-center overflow-x-hidden text-center">
      <h1 className="mt-1 text-2xl sm:text-3xl md:text-4xl lg:text-5xl">
        Winners & 0'fers
      </h1>
      {seasons.length > 0 ? (
        seasonID ? (
          <SeasonWeeksHandler
            currentSeason={currentSeason}
            currentWeek={currentWeek}
            selectedId={seasonID}
            selectOptions={seasons}
            data={results}
            originalDataExists={results.length > 0}
            headers={["Week #", "0'fers", "Winners"]}
            columnWidths={columnWidths}
            rowHeights={rowHeights}
          />
        ) : (
          <span className="text-red-500">
            Season {currentSeason} does not exist
          </span>
        )
      ) : (
        <h3 className="text-red-500">No seasons exist</h3>
      )}
    </div>
  )
}
